stages:
  - secrets
  - pre-build
  - build
  - test
  - security
  - release

include:
  - local: "/.gitlab/ci/build.yml"
  - local: "/.gitlab/ci/test.yml"
  - local: "/.gitlab/ci/security.yml"
  - local: "/.gitlab/ci/release.yml"
  - template: Security/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

variables:
  GITLAB_ADVANCED_SAST_ENABLED: "true"

# 1. Run Secrets check FIRST (Fail cheapest/fastest)
secret_detection:
  stage: secrets

# 2. Run Static Analysis & Dependency checks
sast:
  stage: pre-build

# Replace Deprecated Gemnasium with Trivy FS Scan
trivy_fs_scan:
  stage: pre-build
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs . --exit-code 1 --severity CRITICAL,HIGH --scanners vuln,misconfig
