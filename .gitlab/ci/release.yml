release_latest:
  stage: release
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DEST_REGISTRY: "gcr.dontfail.net"
  script:
    - docker load -i image.tar
    # Use GitLab Job Token for authentication (works if DEST_REGISTRY is on this GitLab instance)
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $DEST_REGISTRY
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $DEST_REGISTRY/$CI_PROJECT_PATH:latest
    - docker push $DEST_REGISTRY/$CI_PROJECT_PATH:latest
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $DEST_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_TAG
        docker push $DEST_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_TAG
      fi
  only:
    - main
    - tags
