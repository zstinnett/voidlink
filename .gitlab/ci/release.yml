release_latest:
  stage: release
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DEST_REGISTRY: "gcr.dontfail.net"
  script:
    - docker load -i image.tar
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # Assuming we might need to login to the destination registry separately if it's different
    # - docker login -u $DEST_USER -p $DEST_PASSWORD $DEST_REGISTRY
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $DEST_REGISTRY/voidlink/amneziawg-go:latest
    - docker push $DEST_REGISTRY/voidlink/amneziawg-go:latest
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $DEST_REGISTRY/voidlink/amneziawg-go:$CI_COMMIT_TAG
        docker push $DEST_REGISTRY/voidlink/amneziawg-go:$CI_COMMIT_TAG
      fi
  only:
    - main
    - tags
